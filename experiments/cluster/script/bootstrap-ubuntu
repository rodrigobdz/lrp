#!/usr/bin/env bash
#
# Install project dependencies for Ubuntu.

set -o errexit
set -o pipefail
set -o nounset

init_bashrc() {
  # Check if .bashrc already exists
  if [ -f /home/rodrigo/.bashrc ]; then
    echo 'Back up existing .bashrc'
    mv /home/rodrigo/.bashrc /home/rodrigo/.bashrc.bak
  fi

  echo 'Install .bashrc'
  ln -s /home/rodrigo/masterarbeit/bashrc /home/rodrigo/.bashrc
}

install_miniconda() {
  echo "Download Miniconda's installation script"
  wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

  echo 'Install Miniconda'
  bash Miniconda3-latest-Linux-x86_64.sh

  # Command is shown when running a conda command in an outdated environment.
  echo 'Update conda'
  conda update --name base --channel defaults conda

  echo 'Create new conda environment'
  conda create --name masterarbeit_env python=3.8 --yes

  echo 'Activate created conda environment'
  conda activate masterarbeit_env

  echo 'Install Pytorch with CUDA support'
  conda install pytorch torchvision torchaudio cudatoolkit=11.3 --channel pytorch --yes
}

transfer_data_hint() {
  echo 'Transfer dataset from local machine to cluster. Execute the following command locally:'
  # Data folder is located inside lrp repo folder but not checked into git.
  echo 'rsync --archive --compress --verbose --human-readable --progress data ml:/home/rodrigo/'
}

transfer_code_hint() {
  echo 'Transfer code from local machine to cluster. Execute the following command locally:'
  # TODO: Add command to transfer code to cluster.
}

main() {
  init_bashrc
  install_miniconda
  transfer_data_hint
  transfer_code_hint
}

main
